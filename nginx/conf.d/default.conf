# ---- 80 (http) 서버블록: 리다이렉트 + ACME 처리 ----
server {
    listen 80;
    server_name example.com 34.170.194.91;

    # ACME(인증서 발급/갱신)용
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;   # webroot 방식 쓸 경우
    }

    # 그 외는 https로 리다이렉트 (IP 운영은 상황따라 비활성화 가능)
    return 301 https://$host$request_uri;
}

# ---- 443 (https) 서버블록: 실제 서비스 ----
server {
    listen 443 ssl;
    server_name example.com 34.170.194.91;

    ssl_certificate     /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # 정적/미디어 (STATIC_ROOT/MEDIA_ROOT와 일치)
    location /static/ { alias /app/invitation/backend/static_collected/; access_log off; expires 1y; }
    location /media/  { alias /app/invitation/backend/media/;           access_log off; }

    client_max_body_size 50M;
    client_body_timeout 120s;

    # 나머지는 Django로 프록시
    location / {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}